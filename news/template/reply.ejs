<!-- reply.ejs -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>ëŒ“ê¸€</h1>
    <hr />

    <div id="replyForm">
      <textarea name="replyContent" id="replyContent" style="width: 95%"></textarea> <br />
      <button type="button" id="btnRegReply" onclick="regReply('<%= newsContent.nid %>')">ë“±ë¡ ì™„ë£Œ</button>
    </div>

    <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë™ì  html -->
    <ul id="replyList"></ul>

    <script>
      replyList('<%= newsContent.nid %>');

      // â¡ï¸ ë§¨ì²˜ìŒ í˜¸ì¶œë˜ëŠ” ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ í•¨ìˆ˜
      function replyList(nid) {
        // get ë°©ì‹ìœ¼ë¡œ nid ê°’ì„ ë„˜ê¸´ í›„ json íƒ€ì…ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        fetch('/reply/' + nid) //  ex /reply/299 -> /reply/:nid
          .then(response => response.json()) // jsonìœ¼ë¡œ ë³€í™˜
          .then(rlist => {
            // alert(JSON.stringify(rlist));
            const output = `
            ${rlist.map(reply => `
              <p>
                <li style="display:inline"> ${reply.content} </li>
                <button onclick="reply_remove(${reply.rid})">ì‚­ì œ</button>
              </p>
              `).join('\n')}
            `;
            document.querySelector('#replyList').innerHTML = output;
          })
          .catch();
        // ë™ì  HTMLë¡œ ì½”ë“œ ì¶œë ¥
      }

      // â¡ï¸ ëŒ“ê¸€ ë“±ë¡í•˜ëŠ” ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ í•¨ìˆ˜
      function regReply(nid) {
        const replyContent = document.querySelector('#replyContent').value;

        fetch('/reply', {
          method: 'post',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ nid: nid, content: replyContent }),
        })
          .then(response => {
            if (response.status === 201) {
              window.location.reload(); // reply ì¬í˜¸ì¶œ : replyList() í•¨ìˆ˜ ì‹¤í–‰
            }
          })
          .catch();
      }

      function reply_remove(rid) {
        fetch('/reply', {
          method : 'delete',
          headers : {'content-type' : 'application/json'},
          body : JSON.stringify({rid : rid}),
        })
        .then(result => {
          if (result.status === 204) {
            alert('ì‚­ì œ ğŸ¥³')
            window.location.reload();
          } 
        })
        .catch(console.error);
      }
    </script>
  </body>
</html>
